pipeline {
    
    agent { 
        docker {
            args '-u root:sudo'
            image 'cypress/base:10.8.0'
        }
    }
    stages {
        stage('build') {
            steps {
                sh 'sudo ls -la /'
                sh 'sudo ls -la /.cache'
                sh 'sudo mkdir /.yarn'
                sh 'sudo chmod -R 777 /.cache'
                sh 'sudo chmod -R 777 /.yarn'
                sh 'yarn install:all'
                sh 'yarn run cypress verify'
                sh 'yarn workspace linode-js-sdk build'
            }
        }
        
        stage('start local server') {
            steps {
                // start local server in the background
                // we will shut it down in "post" command block
                sh 'nohup yarn up &'
            }
        }

        stage('cypress parallel tests') {
            steps {
                echo "Running build ${env.BUILD_ID}"
                sh "yarn cy:e2e"
            }
        }
    }
}