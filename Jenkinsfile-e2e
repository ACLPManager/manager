node {
    /* Requires the Docker Pipeline plugin to be installed */
    docker.image('node:10-slim').inside('-u node -w /home/node/app') {

        stage('build') {

                sh 'echo $(whoami)'
                sh 'echo $CYPRESS_CACHE_FOLDER'
                sh 'pwd'
                sh 'yarn cache dir'
                sh 'yarn global dir'
                sh 'yarn global add cypress@3.8.2'
                sh 'yarn install:all'
                sh 'yarn run cypress verify'
                sh 'yarn workspace linode-js-sdk build'
        }
        
        stage('start local server') {

                // start local server in the background
                // we will shut it down in "post" command block
                sh 'nohup yarn up &'

        }

        stage('cypress parallel tests') {

                echo "Running build ${env.BUILD_ID}"
                sh "yarn cy:e2e"

        }
    }
}


